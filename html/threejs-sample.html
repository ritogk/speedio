<!DOCTYPE html>
<html>
  <head>
    <title>Simple 3D Polyline with Three.js</title>
    <style>
      body {
        margin: 0;
      }
      canvas {
        display: block;
      }
    </style>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js",
          "OrbitControls": "https://unpkg.com/three@0.164.1/examples/jsm/controls/OrbitControls.js"
        }
      }
    </script>
    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "https://unpkg.com/three@0.164.1/examples/jsm/controls/OrbitControls.js";

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );

      const renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById("three-area").appendChild(renderer.domElement);
      // Z軸が上になるようにカメラの向きを設定
      camera.up.set(0, 0, 1);
      camera.position.set(0, 0, 200); // Z軸を真上から見る。
      camera.lookAt(0, 0, 0); // 原点を見る

      const axesHelper = new THREE.AxesHelper(100); // 軸の長さを指定
      scene.add(axesHelper);

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.25;

      // 描画処理
      const elevations = JSON.parse(
        "[73.8000030518,72.5999984741,74.5999984741,84.6999969482,82.1999969482,82.3000030518,82.5999984741,82.4000015259,81.5999984741,81.3000030518,84.0999984741,83.9000015259,84.3000030518,95.9000015259,96,97.8000030518,99.8000030518,105.9000015259,108.3000030518,111.0999984741,113.4000015259,115.3000030518,116,115.5,119.5,123.5,125.1999969482,122.5,131.3000030518,131.3000030518,134.1999969482,134.1999969482,138.1000061035,136.3999938965,136.5,132.8000030518,133.1999969482,144.1999969482,149.1000061035,149.6999969482,148,148,148.8999938965,148.1999969482,147.3000030518,149.6999969482,149.1000061035,147.8999938965,147.8999938965,157.3000030518,157.6000061035,155.5,155.5,156.8999938965,156.8999938965,156.6999969482,156,156,157.3000030518,155.6000061035,158.5,158.5,167.5,168.3000030518,164.1999969482,165.3000030518,165.3000030518,166,166,167.1000061035,170,173.6000061035,177.3000030518,177.3000030518,176.3000030518,176.3000030518,178.6999969482,178.6999969482,177.6000061035,177.8999938965,177.3000030518,177.3000030518,177.3000030518,177.3000030518,182.1999969482,188.5,188.6000061035,188,188,188,185,185,187.1999969482,195.1999969482,196.8000030518,196.8000030518,196.8000030518,197.1000061035,197.1000061035,197.1000061035,200.1999969482,206.6999969482,209.6999969482,223.8999938965,246,262.799987793,231,223.3000030518,214.8999938965,216,213.6000061035,207.1000061035,206.3000030518,206.3000030518,207.3000030518,207.5,207.5,207.5,206.3000030518,204.5,200.3999938965,196.8000030518,193.8000030518,197.3000030518,194.6000061035,196.8999938965,196.8999938965,195.1000061035,197,186,186.8999938965,187.1000061035,189.1999969482,187.6999969482,184.6999969482,186.6000061035,179.8000030518,176.8000030518,175.3000030518,175.3000030518,178.6000061035,177.5,174.5,176,176,174.3999938965,174.1999969482,173.3000030518,171.5,168.8000030518,166.6999969482,168.8000030518,165.6999969482,163.8999938965,163.8999938965,163.6000061035,162.6999969482,161.6000061035,161.6000061035,158.1999969482,158.1999969482,158,156.5,158.1000061035,158.1000061035,155.1000061035,157.6999969482,157.3999938965,157.3999938965,154.8999938965,154.8999938965,145,147.8000030518,146.3000030518,146.3000030518,146.1999969482,146.1999969482,146.1999969482,147.3000030518,147.3000030518,147.3000030518,148.3000030518,147.8999938965,147.8999938965,145.1000061035,141.6000061035,138.1999969482,138.1000061035,136.6999969482,139,138.1000061035,138.5,138.5,136,137.3999938965,136.6999969482,135.6000061035,135.6000061035,135.6000061035,132.3999938965,129.6999969482,129.6999969482,126.5,128.3000030518,128.3000030518,128.1999969482,125.4000015259,114.5,115.5,116.6999969482,114.3000030518,115.0999984741,112.5]"
      );
      const coordinates = JSON.parse(
        "[[-128635.6284735161,-247210.6315314788],[-128616.6903630502,-247193.8822875377],[-128568.1757990963,-247159.547930438],[-128511.234983114,-247099.9646640907],[-128469.4089958402,-247073.7428949236],[-128459.2229444117,-247057.7610787257],[-128454.0917998696,-247037.9862129293],[-128453.3067388846,-247011.4591834708],[-128448.7213621223,-246996.9837452027],[-128413.269161186,-246953.8528845453],[-128395.2240199888,-246936.0936549652],[-128374.0678347553,-246927.4737140613],[-128350.9108485378,-246921.8132129626],[-128269.0102816218,-246924.3443221702],[-128245.1905471721,-246929.2809575045],[-128220.0486553228,-246937.5432109181],[-128165.1247408164,-246942.4486074907],[-128140.4999206415,-246933.9735806088],[-128114.9809631387,-246926.5369229893],[-128066.0781781962,-246886.3795599254],[-128061.5840796815,-246877.1733904581],[-128062.5593017013,-246862.3903244353],[-128068.9258358976,-246852.7711718205],[-128079.9098005556,-246846.5366664156],[-128123.9781000096,-246846.3942840248],[-128142.1475505697,-246843.027343395],[-128158.7563607097,-246835.7534713209],[-128184.0657995395,-246826.6254614224],[-128228.0135615781,-246822.2941739999],[-128236.5136934531,-246820.0499856187],[-128242.4342656988,-246814.6224521758],[-128245.5317090466,-246807.6352672163],[-128253.8015244494,-246750.7807681918],[-128251.7763745373,-246735.2389766284],[-128226.012153441,-246705.531549702],[-128219.9350363392,-246701.9153423214],[-128212.4698106764,-246702.4289981278],[-128187.2441708293,-246712.5762318732],[-128169.3688100683,-246717.3984169639],[-128158.9820935088,-246717.1191263393],[-128151.0359310724,-246711.9781445444],[-128147.515644379,-246705.7838777499],[-128141.9937339217,-246695.5609789669],[-128138.3930275836,-246689.0531720099],[-128134.0942701771,-246679.5958642974],[-128131.7314374397,-246672.480251085],[-128129.3956636767,-246664.3579288245],[-128127.9601926123,-246659.9232339627],[-128127.6885375962,-246653.5049466025],[-128128.1939866303,-246614.0451963417],[-128128.2008135551,-246605.5279334575],[-128126.7702341325,-246600.9102120587],[-128123.961287941,-246597.9955691869],[-128119.6728462727,-246596.4149449068],[-128114.5830232386,-246595.7286366573],[-128104.5884197435,-246595.7347727154],[-128096.2411354704,-246596.426277695],[-128087.8963107138,-246597.0262616697],[-128060.5711182364,-246601.4205920404],[-128028.1908116489,-246607.9686261187],[-128020.8201081644,-246609.510615371],[-128013.2422253434,-246610.4975269431],[-128006.5840746409,-246610.3185627277],[-127998.2859853139,-246609.1796767484],[-127991.0013778721,-246607.5185288054],[-127983.9534678399,-246605.3142409735],[-127976.6590204009,-246604.0191687476],[-127969.3498136471,-246603.2732044013],[-127963.4782864664,-246602.7490509255],[-127956.2726691903,-246602.2806230286],[-127923.1150216667,-246600.5651391228],[-127906.0356061825,-246599.7397332393],[-127899.8434703391,-246598.7490478395],[-127894.7041736298,-246595.7718338019],[-127891.6659112719,-246593.1258439731],[-127889.6657273163,-246589.0424283935],[-127887.6975180167,-246583.769294794],[-127887.1694455428,-246578.6264527389],[-127887.4716870749,-246563.2486304539],[-127889.3892530866,-246549.7458790798],[-127891.4380457608,-246543.7564577323],[-127893.0949045251,-246539.9544947244],[-127895.6223003096,-246536.8170048558],[-127897.4346955333,-246535.4919614475],[-127901.0348932619,-246533.7570431976],[-127904.1420299292,-246533.8405369063],[-127915.7024967744,-246533.4185185453],[-127940.7099054077,-246532.6251655815],[-127946.9536884222,-246531.6939402137],[-127950.1001713662,-246530.3131517996],[-127953.6905306675,-246528.9442895753],[-127956.563124113,-246525.3581319398],[-127958.9128379112,-246520.5673348226],[-127992.3002067947,-246435.1923570482],[-127995.5639518155,-246421.1760964486],[-127995.8466195388,-246410.6515379797],[-127993.4614669866,-246404.3597749606],[-127988.9162831351,-246399.9332661822],[-127985.0098763447,-246396.5313382945],[-127981.618989681,-246394.6085978619],[-127968.5660463041,-246388.5798666904],[-127947.6609521115,-246377.211613757],[-127916.5757964879,-246360.3498073103],[-127882.8097647597,-246339.9359791939],[-127846.2494098525,-246316.0587221082],[-127776.3745050263,-246275.6268237562],[-127705.8704798199,-246233.8049015444],[-127665.8629219657,-246214.2318199287],[-127643.7689143882,-246201.6418342769],[-127624.5379851182,-246189.9529601149],[-127582.8383392934,-246167.221101942],[-127525.29074661,-246130.876828483],[-127513.6159393921,-246123.1456966704],[-127507.0854704539,-246118.2083873944],[-127497.6320051096,-246106.3242653868],[-127488.9179912327,-246091.7126502701],[-127486.2984293081,-246085.8729296978],[-127481.2340898374,-246071.8171490608],[-127477.0948099975,-246060.5335504468],[-127473.8275152526,-246041.5807731684],[-127474.222683341,-246026.8472636914],[-127474.7298496259,-246020.3588061567],[-127473.9569219196,-246011.9128737339],[-127470.3410437574,-246005.954892969],[-127462.698372735,-246001.0794451772],[-127434.699585998,-245980.914075076],[-127427.9244806477,-245972.6735508465],[-127424.8977777846,-245965.4493258025],[-127419.6732199177,-245953.2209793362],[-127380.9456186903,-245902.4561250458],[-127371.8523644609,-245893.6956823565],[-127362.8700717335,-245884.9382313099],[-127351.1386612912,-245879.312299614],[-127337.4858461843,-245870.795998053],[-127328.7628561977,-245864.7928514389],[-127322.4020983505,-245857.662535402],[-127315.0162895086,-245839.0576898479],[-127307.2564548097,-245826.1205922932],[-127303.2241755105,-245823.265236083],[-127297.3501756034,-245822.8330861402],[-127284.1749014868,-245825.502007879],[-127270.5876325198,-245826.9693895284],[-127258.7703557821,-245824.5464358299],[-127252.0601055473,-245822.1687790298],[-127243.1697136405,-245818.2674854592],[-127232.7600877255,-245813.0434248988],[-127223.1376647278,-245811.5950696498],[-127213.3405106464,-245812.5229961411],[-127205.7805134495,-245816.9907394835],[-127195.3684126908,-245828.4333367754],[-127188.4797264762,-245836.8567858223],[-127154.8833728288,-245888.7950761336],[-127145.0297812248,-245891.8276158617],[-127138.4207024928,-245889.8189399305],[-127132.03356152,-245887.8162161569],[-127110.5222898109,-245865.9026724134],[-127093.3178724282,-245853.1705292941],[-127086.9650647872,-245849.886718807],[-127082.575359581,-245847.9375707882],[-127076.9404665022,-245846.8707898897],[-127070.6078725451,-245846.9757719067],[-127063.8491635834,-245850.5491447635],[-127047.9068923882,-245869.4439055064],[-127036.9980106919,-245891.1291831982],[-127033.9012608986,-245894.8006862572],[-127029.2337690514,-245899.0710911018],[-127021.7920481871,-245903.2671121803],[-127015.9946689745,-245904.1189892172],[-127007.5138389622,-245901.5106977896],[-127003.8046784718,-245899.0303415175],[-126999.7699702311,-245896.2665387766],[-126960.3952920074,-245857.2080795613],[-126952.8187872216,-245849.8622920267],[-126945.9454749696,-245845.2825511585],[-126940.6557529415,-245843.7671669506],[-126932.7965723706,-245842.8239189358],[-126926.229774835,-245843.3804766611],[-126921.7370491451,-245845.2746457715],[-126917.6734817695,-245847.729752169],[-126913.2279475292,-245852.0060679778],[-126910.2470858875,-245855.4974901274],[-126909.2887787072,-245862.2481665073],[-126909.16121852,-245867.0065174807],[-126910.6442224377,-245873.8226410155],[-126918.8599239328,-245902.8882718137],[-126918.0616213956,-245907.811790664],[-126910.8781453065,-245943.7903597417],[-126909.7253692002,-245953.6492881944],[-126911.6816343723,-245959.3792533999],[-126933.6239248153,-245998.336735038],[-126935.893435041,-246004.8077125714],[-126935.2482893482,-246012.2993879993],[-126931.9197295822,-246016.3308848301],[-126926.4110592723,-246018.8387329519],[-126898.8072586295,-246021.2117458999],[-126880.3593818932,-246021.7241806852],[-126867.3391733449,-246022.7484968379],[-126858.809278148,-246021.9702469963],[-126855.6132653392,-246021.0603638277],[-126852.2394980075,-246018.4974148663],[-126848.9025493117,-246014.5618742559],[-126845.7232049303,-246008.8906954308],[-126843.1924904961,-246003.8779232487],[-126825.2186660056,-245970.1552366219],[-126821.4230967155,-245966.7568567871],[-126814.0936932732,-245962.6227032909],[-126802.8067464014,-245961.129566051],[-126728.9272324156,-245949.899514068],[-126718.9075704303,-245946.7005382327],[-126706.9231797495,-245944.712552187],[-126698.3500954645,-245941.8179358683],[-126689.1699815189,-245935.8852217738],[-126683.8623584928,-245935.0377934548]]"
      );
      const minX = Math.min(...coordinates.map((coord) => coord[0]));
      const minY = Math.min(...coordinates.map((coord) => coord[1]));

      const points = coordinates.map((coord, index) => {
        // const x = point[0];
        // const y = point[1];
        const x = (coord[0] - minX) / 10;
        const y = (coord[1] - minY) / 10;
        const z = elevations[index] / 10;
        return new THREE.Vector3(x, y, z);
      });

      const offsetDistance = 1; // オフセット距離
      let normalVectors = [];

      for (let i = 0; i < points.length - 1; i++) {
        let p1 = points[i];
        let p2 = points[i + 1];
        let direction = new THREE.Vector3().subVectors(p2, p1).normalize();
        let normal = new THREE.Vector3(-direction.y, direction.x, 0);
        normalVectors.push(normal);
      }

      // 最後の法線ベクトルは一つ前のものを使用
      normalVectors.push(normalVectors[normalVectors.length - 1]);

      const offsetPoints = points.map((point, index) => {
        return new THREE.Vector3().addVectors(
          point,
          normalVectors[index].multiplyScalar(offsetDistance)
        );
      });

      // 平面を生成する
      const vertices = [];
      points.forEach((point, index) =>
        vertices.push(point.x, point.y, point.z)
      );
      offsetPoints.forEach((point, index) =>
        vertices.push(point.x, point.y, point.z)
      );

      const faces = [];
      for (let i = 0; i < points.length - 1; i++) {
        const n = points.length;
        // 下面の三角形
        faces.push(i, i + n, i + 1);
        // 上面の三角形
        faces.push(i + 1, i + n, i + n + 1);
      }

      // 平面ジオメトリの作成
      const geometry = new THREE.BufferGeometry();

      const verticesFloat32 = new Float32Array(vertices);
      geometry.setAttribute(
        "position",
        new THREE.BufferAttribute(verticesFloat32, 3)
      );
      const indicesUint16 = new Uint16Array(faces);
      geometry.setIndex(new THREE.BufferAttribute(indicesUint16, 1));

      const material = new THREE.MeshBasicMaterial({
        side: THREE.DoubleSide,
        color: 0xdbdcdc,
      });
      const mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);

      // エッジの描画
      const edges = new THREE.EdgesGeometry(geometry);
      const line = new THREE.LineSegments(
        edges,
        new THREE.LineBasicMaterial({ color: 0xaaacaa })
      );

      // シーンへの追加
      scene.add(line);

      // Render loop
      function animate() {
        requestAnimationFrame(animate);
        controls.update(); // only required if controls.enableDamping = true, or if controls.autoRotate = true
        renderer.render(scene, camera);
      }

      animate();
    </script>
  </head>
  <body>
    <div id="three-area"></div>
  </body>
</html>
